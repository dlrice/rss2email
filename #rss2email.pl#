#!/usr/bin/perl

use strict;
use lib '/nfs/users/nfs_j/jb26/lib/perl/lib/site_perl';
use lib '/nfs/users/nfs_j/jb26/lib/perl/lib/site_perl/5.8.8/x86_64-linux-thread-multi';

use DateTime::Format::W3CDTF;
use Time::localtime;
use MIME::Lite;

my $debug = 1;

my $lastdate = DateTime->from_epoch(epoch => 0);
my $datetimeformatter = DateTime::Format::W3CDTF->new;

#pull down the feed list (seems to be the only consistent way 
#to get the request out of the internal network, i.e. not possible by HTTP:Request?)
system("wget -O journalpix.rdf http://www.citeulike.org/rss/group/10570/library");

open (IN, "lastupdate.txt");
my $e = <IN>;
chomp($e);
close IN;  
$lastdate = DateTime->from_epoch(epoch => $e);

if (!(-s "journalpix.rdf")){
  die "No journalpix source file. Disaster?\n";
}

open (my $in, "<", "journalpix.rdf");
my $in_item = 0;
my @items;
my %titles;
my %tags;
my %links;
my %authors;
my %sources;
my %dates;
while (<$in>){
    if (/<item rdf:about=\"(.+)\">/){
	my $id = $1;
	push @items, $id;
	my @a;
	my $doi;
	while (<$in>){
	    if (/<title>(.+)<\/title>/){
		$titles{$id} = $1;
	    }elsif (/<dc:creator>(.+)<\/dc:creator>/){
		push @a, $1;
	    }elsif (/<dc:source>(.+)<\/dc:source>/){
		$sources{$id} = $1;
	    }elsif (/<dc:identifier>(.+)<\/dc:identifier>/){
		$doi = $1;
	    }elsif (/<prism:category>(.+)<\/prism:category>/){
		$tags{$id} .= $1;
	    }elsif (/<dc:date>(.+)<\/dc:date>/){
		$dates{$id} = $1;
	    }elsif (/<\/item>/){
		if ($#a == 0){
		    $authors{$id} = $a[0];
		}else{
		    my $count = 0;
		    my $ultimate;
		    my $penultimate;
		    foreach my $a (@a){
			if ($count == 0){
			  $authors{$id} .= "$a";
			}elsif ($count <= 2){
			  $authors{$id} .= ", $a";
			}else{
			  $penultimate = $ultimate;
			  $ultimate = $a;
			}
			$count++;
		    }
		    if ($count == 4){
		      $authors{$id} .= ", $ultimate";
		    }elsif ($count == 5){
		      $authors{$id} .= ", $penultimate, $ultimate";
		    }elsif ($count > 5){
		      $authors{$id} .= " ... $penultimate, $ultimate";
		    }
		}
		$authors{$id} .= ".";

		if ($doi){
		    $links{$id} = "http://dx.doi.org/$doi";
		}else{
		    $links{$id} = $id;
		}
		
		last;
	    }
	}
    }
}

my $message = "";    #"<html><body>";

if (-s "header.txt"){
    open (IN, "header.txt");
    while (<IN>){
	$message .= $_;
    }
    close IN;
}else{
    $message .= "This week's journal pix!\n\n";
}
my $newstuff = 0;

my $bioinfsection, my $cancersection, my $humsection, my $malariasection, my $modelsection, my $pathsection, my $othersection;
foreach my $item ( @items ) {
  my $date = $datetimeformatter->parse_datetime($dates{$item});
  if ($date > $lastdate){
      my $outstring = "$titles{$item} ($links{$item})\n$authors{$item} $sources{$item}\n\n";
	  $newstuff = 1;
      if ($tags{$item} =~ /staffpaper/i){
	  $outstring = "[Staff paper] $outstring";
      }

      if ($tags{$item} =~ /bioinformatics/i || $tags{$item} =~ /annotation/i || $tags{$item} =~ /informatics/i){
	  $bioinfsection .= $outstring;
      }elsif ($tags{$item} =~ /cancer/i){
	  $cancersection .= $outstring;
      }elsif ($tags{$item} =~ /humgen/i || $tags{$item} =~ /human/i){
	  $humsection .= $outstring;
      }elsif ($tags{$item} =~ /malaria/i){
	  $malariasection .= $outstring;
      }elsif ($tags{$item} =~ /mouse/i || $tags{$item} =~ /zebrafish/i || $tags{$item} =~ /model/i){
	  $modelsection .= $outstring;
      }elsif ($tags{$item} =~ /pathogens/i || $tags{$item} =~ /pathogen/i){
	  $pathsection .= $outstring;
      }else{
	  $othersection .= $outstring;
      }
  }
}

$message .= "*Informatics*\n----------------\n$bioinfsection";
$message .= "*Cancer*\n----------------\n$cancersection";
$message .= "*Human Genetics*\n----------------\n$humsection";
$message .= "*Malaria*\n----------------\n$malariasection";
$message .= "*Model Organisms*\n----------------\n$modelsection";
$message .= "*Pathogens*\n----------------\n$pathsection";
$message .= "*Other*\n----------------\n$othersection";

$message .= "\nTo get copies of any non-subscribed picks in this list, please contact the library:  https://helix.wtgc.org/services/ordering-articles-and-inter-library-loans\n";

my $subject;
my $to;
my $from = "The Journal Annotation Team<journal_picks\@sanger.ac.uk>";

if ($newstuff){
  $subject = "Journal Picks Weekly Digest";
  if (!$debug){
    $to = "hinx\@sanger.ac.uk, all\@ebi.ac.uk";
  }else{
    $to = "jb26\@sanger.ac.uk";
  }
}else{
  $subject = "No new picks!";
  if (!$debug){
    $to = "journal_picks\@sanger.ac.uk";
  }else{
    $to = "jb26\@sanger.ac.uk";
  }
  $message = "There weren't any new picks, so I didn't send an update email.\nYou'd better work harder at picking articles!\n"
}

my $msg = MIME::Lite->new( To => $to, Subject => $subject, Type => 'text/plain', From=>$from, Data=>$message);
$msg->attr('content-type.charset' => 'UTF8');

$msg->send();

if (!$debug){
  open (OUT, ">lastupdate.txt");
  my $e = time();
  print OUT "$e\n";
  close OUT;

  system("rm journalpix.rdf");
}
